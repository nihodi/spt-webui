<div class="center">
	@if (playbackState.isPlaying$ | async) {
		<section>
			<h1>Currently listening to</h1>
			<app-track-card [track]="(playbackState.playbackState$ | async)?.item!"></app-track-card>
			<app-playback-state-display
				[playbackState]="(playbackState.playbackState$ | async)!"></app-playback-state-display>
		</section>


		<section>
			<h1>Submit songs</h1>

			@if (authService.isLoggedIn$ | async) {
				<form class="request-form" [formGroup]="addToQueueForm" (ngSubmit)="addToQueue()">
					<input placeholder="Song link" type="text" [formControl]="addToQueueForm.controls.url">
					<button type="submit" [disabled]="!addToQueueForm.valid">
						@if (playbackState.rateLimitCountdown$ | async) {
							{{ playbackState.rateLimitCountdown$ | async }}
						} @else {
							Add to queue
						}

					</button>
				</form>
			} @else {
				<p>You need to be logged in to submit songs!</p>
			}
		</section>


		<section>
			<h1>Current queue:</h1>
			@if ((playbackState.trueQueue$ | async) !== null) {
				@if ((playbackState.trueQueue$ | async)?.queue!.length > 0) {
					<app-track-list [tracks]="(playbackState.trueQueue$ | async)?.queue!"></app-track-list>
				} @else {
					<p>The queue is empty. Request your song to hear it instantly!</p>
				}
			}

			<h2>Next up:</h2>
			<p>Songs that play when the queue is empty.</p>
			@if ((playbackState.trueQueue$ | async) !== null) {
				<app-track-list [tracks]="(playbackState.nextUpQueue$ | async)?.queue!"></app-track-list>
			}
		</section>

	} @else {
		@if (playbackState.isInitialLoad$ | async) {
			<div class="vertical-center">
				<app-spinner></app-spinner>
				<h1>Loading playback state...</h1>
			</div>

		} @else {
			<section>
				<h1>Not online :(</h1>

				<h3>No songs can be submitted, because I'm offline on Spotify.</h3>
			</section>
		}

	}

	<section class="stats">
		<h1>Stats</h1>

		@if ((statsService.currentStats$ | async) !== null) {

			@defer (on viewport) {
				<div class="stat-display-simple">
					<h3>
						<app-rolling-counter
							[value]="(statsService.currentStats$ | async)?.total_requests!"
						></app-rolling-counter>
					</h3>
					<div>Total requests</div>
				</div>
			} @placeholder {
				<div class="stat-display-simple-placeholder"></div>
			}


			<hr>

			@defer (on viewport) {
				<div class="stat-display-simple">
					<h3>
						<app-rolling-counter
							[value]="(statsService.currentStats$ | async)?.total_ms_listened!"
							[format]="msToDaysHoursMinutes"
						></app-rolling-counter>
					</h3>
					<div>Total time listened</div>
				</div>
			} @placeholder {
				<div class="stat-display-simple-placeholder"></div>

			}

			<hr>

			<h2>Requests by date</h2>
			<canvas baseChart type="line"
					[data]="(statsService.currentStats$ | async)?.request_grouped_by_date_chartable"
			>
			</canvas>

			<hr>

			<h2>Most popular songs</h2>
			<app-app-popular-tracks-list
				[tracks]="(statsService.currentStats$ | async)?.most_requested_songs!"></app-app-popular-tracks-list>

		} @else {
			<app-spinner></app-spinner>
		}


	</section>
</div>
